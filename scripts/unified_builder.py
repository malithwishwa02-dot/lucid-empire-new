"""\nLUCID EMPIRE: UNIFIED BUILD ORCHESTRATOR\n----------------------------------------\nAUTHORITY: Dva.12\nPURPOSE: Master orchestrator for building Backend + Frontend + Installer\nUSAGE: python unified_builder.py\n"""\n\nimport os\nimport subprocess\nimport shutil\nimport platform\nimport sys\nfrom pathlib import Path\n\n\n# Configuration\nAPP_NAME = \"lucid-empire\"\nVERSION = \"5.0.0\"\nROOT_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))\nDIST_DIR = os.path.join(ROOT_DIR, \"dist\")\nBUILD_DIR = os.path.join(ROOT_DIR, \"build\")\nSRC_TAURI = os.path.join(ROOT_DIR, \"src-tauri\")\n\n\ndef log(msg):\n    \"\"\"Print status message in green\"\"\"\n    print(f\"\\033[92m[OBLIVION] {msg}\\033[0m\")\n\n\ndef warn(msg):\n    \"\"\"Print warning in yellow\"\"\"\n    print(f\"\\033[93m[WARN] {msg}\\033[0m\")\n\n\ndef error(msg):\n    \"\"\"Print error and exit\"\"\"\n    print(f\"\\033[91m[ERROR] {msg}\\033[0m\")\n    sys.exit(1)\n\n\ndef check_env():\n    \"\"\"Verify all required tools are available\"\"\"\n    log(\"Verifying Environment...\")\n    \n    # Check Python\n    if sys.version_info < (3, 10):\n        error(f\"Python 3.10+ required. Found {sys.version}\")\n    log(f\"✓ Python {sys.version.split()[0]}\")\n    \n    # Check Node (optional for backend-only builds)\n    if shutil.which(\"npm\") is not None:\n        log(\"✓ Node.js/npm found\")\n    else:\n        warn(\"Node.js/npm not found. Frontend build will be skipped.\")\n    \n    # Check Rust (optional, only needed for Tauri)\n    if shutil.which(\"cargo\") is not None:\n        log(\"✓ Rust/cargo found\")\n    else:\n        warn(\"Rust not found. Tauri frontend build will be skipped.\")\n    \n    # Check/Install PyInstaller\n    if shutil.which(\"pyinstaller\") is None:\n        log(\"Installing PyInstaller...\")\n        try:\n            subprocess.check_call([sys.executable, \"-m\", \"pip\", \"install\", \"pyinstaller\", \"-q\"])\n            log(\"✓ PyInstaller installed\")\n        except subprocess.CalledProcessError:\n            error(\"Failed to install PyInstaller\")\n    else:\n        log(\"✓ PyInstaller found\")\n\n\ndef build_backend():\n    \"\"\"Compile Python backend using PyInstaller\"\"\"\n    log(\">>> BACKEND BUILD PHASE\")\n    log(\"Compiling Lucid Core (Python API Server)...\")\n    \n    # Clean previous builds\n    if os.path.exists(BUILD_DIR):\n        shutil.rmtree(BUILD_DIR)\n    if os.path.exists(DIST_DIR):\n        shutil.rmtree(DIST_DIR)\n    \n    os.makedirs(DIST_DIR, exist_ok=True)\n    \n    # Prepare data paths\n    core_path = os.path.join(ROOT_DIR, \"core\")\n    modules_path = os.path.join(ROOT_DIR, \"modules\")\n    assets_path = os.path.join(ROOT_DIR, \"assets\")\n    \n    # Build PyInstaller command\n    cmd = [\n        \"pyinstaller\",\n        \"--noconfirm\",\n        \"--clean\",\n        \"--onefile\",\n        \"--name\", \"lucid_core\",\n        \"--distpath\", DIST_DIR,\n        \"--buildpath\", BUILD_DIR,\n        \"--hidden-import=core.genesis_engine\",\n        \"--hidden-import=core.time_machine\",\n        \"--hidden-import=modules.biometric_mimicry\",\n        \"--hidden-import=modules.commerce_injector\",\n        \"--hidden-import=modules.humanization\",\n    ]\n    \n    # Add data files if they exist\n    if os.path.exists(core_path):\n        cmd.extend([\"--add-data\", f\"{core_path}{os.pathsep}core\"])\n    if os.path.exists(modules_path):\n        cmd.extend([\"--add-data\", f\"{modules_path}{os.pathsep}modules\"])\n    if os.path.exists(assets_path):\n        cmd.extend([\"--add-data\", f\"{assets_path}{os.pathsep}assets\"])\n    \n    # Add entry point\n    lucid_api = os.path.join(ROOT_DIR, \"lucid_api.py\")\n    if not os.path.exists(lucid_api):\n        error(f\"Entry point not found: {lucid_api}\")\n    \n    cmd.append(lucid_api)\n    \n    try:\n        log(f\"Running: {' '.join(cmd[:5])}...\")\n        subprocess.check_call(cmd)\n        \n        # Verify binary was created\n        binary_name = \"lucid_core\"\n        if platform.system() == \"Windows\":\n            binary_name += \".exe\"\n        \n        binary_path = os.path.join(DIST_DIR, binary_name)\n        if os.path.exists(binary_path):\n            size_mb = os.path.getsize(binary_path) / (1024 * 1024)\n            log(f\"✓ Backend compiled successfully: {binary_path} ({size_mb:.2f} MB)\")\n            return binary_path\n        else:\n            error(f\"Backend binary not found at {binary_path}\")\n    \n    except subprocess.CalledProcessError as e:\n        error(f\"PyInstaller failed with exit code {e.returncode}\")\n\n\ndef build_frontend():\n    \"\"\"Compile Tauri frontend\"\"\"\n    log(\">>> FRONTEND BUILD PHASE\")\n    \n    # Check if Tauri directory exists\n    if not os.path.exists(SRC_TAURI):\n        warn(\"src-tauri directory not found. Skipping frontend build.\")\n        return None\n    \n    # Check if npm is available\n    if shutil.which(\"npm\") is None:\n        error(\"npm not found. Cannot build frontend. Install Node.js.\")\n    \n    # Check if cargo is available\n    if shutil.which(\"cargo\") is None:\n        error(\"cargo not found. Cannot build Tauri app. Install Rust.\")\n    \n    log(\"Building Lucid Commander (Tauri GUI)...\")\n    \n    try:\n        # Change to root directory\n        os.chdir(ROOT_DIR)\n        \n        # Install npm dependencies if needed\n        node_modules = os.path.join(ROOT_DIR, \"node_modules\")\n        if not os.path.exists(node_modules):\n            log(\"Installing npm dependencies...\")\n            subprocess.check_call([\"npm\", \"install\"])\n        \n        # Build Tauri app\n        log(\"Running: npm run tauri build...\")\n        subprocess.check_call([\"npm\", \"run\", \"tauri\", \"build\"])\n        \n        log(\"✓ Frontend compiled successfully\")\n        \n        # Determine output location based on platform\n        if platform.system() == \"Linux\":\n            bundle_path = os.path.join(SRC_TAURI, \"target\", \"release\", \"bundle\", \"deb\")\n        elif platform.system() == \"Windows\":\n            bundle_path = os.path.join(SRC_TAURI, \"target\", \"release\", \"bundle\", \"nsis\")\n        else:  # macOS\n            bundle_path = os.path.join(SRC_TAURI, \"target\", \"release\", \"bundle\", \"dmg\")\n        \n        if os.path.exists(bundle_path):\n            log(f\"Frontend artifacts available at: {bundle_path}\")\n            return bundle_path\n        else:\n            warn(f\"Expected bundle path not found: {bundle_path}\")\n            return None\n    \n    except subprocess.CalledProcessError as e:\n        error(f\"Tauri build failed with exit code {e.returncode}\")\n    except Exception as e:\n        error(f\"Frontend build error: {e}\")\n\n\ndef main():\n    \"\"\"Main orchestration routine\"\"\"\n    print(\"\\n\" + \"=\"*70)\n    print(\"LUCID EMPIRE: UNIFIED BUILD ORCHESTRATOR\")\n    print(f\"VERSION: {VERSION}\")\n    print(f\"ROOT: {ROOT_DIR}\")\n    print(\"=\"*70 + \"\\n\")\n    \n    try:\n        # Phase 1: Environment Check\n        check_env()\n        \n        # Phase 2: Backend\n        backend_binary = build_backend()\n        \n        # Phase 3: Frontend (optional)\n        frontend_path = None\n        if shutil.which(\"npm\") and shutil.which(\"cargo\"):\n            try:\n                frontend_path = build_frontend()\n            except Exception as e:\n                warn(f\"Frontend build skipped: {e}\")\n        \n        # Summary\n        print(\"\\n\" + \"=\"*70)\n        print(\">>> BUILD COMPLETE\")\n        print(\"=\"*70)\n        print(f\"\\n✓ Backend:  {backend_binary}\")\n        if frontend_path:\n            print(f\"✓ Frontend: {frontend_path}\")\n        print(f\"\\nAll artifacts in: {DIST_DIR}\")\n        print(\"=\"*70 + \"\\n\")\n        \n    except KeyboardInterrupt:\n        error(\"\\nBuild interrupted by user\")\n    except Exception as e:\n        error(f\"Unexpected error: {e}\")\n\n\nif __name__ == \"__main__\":\n    main()\n
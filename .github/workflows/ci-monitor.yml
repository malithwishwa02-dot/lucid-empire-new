name: Build Lucid Empire .deb Bundle (OFFENSIVE/BINARY MODE)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-oblivion-bundle:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    env:
      DEBIAN_FRONTEND: noninteractive
      L_E_OUTDIR: lucid-empire-bundle

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Fix Invalid Submodules
        run: |
          # Remove invalid submodule 'aa' if present (prevents spurious CI warnings/failures)
          git submodule status | grep '^-' | awk '{print $2}' | xargs -r git rm --cached || true
          git config --remove-section submodule.aa 2>/dev/null || true
          rm -rf .git/modules/aa 2>/dev/null || true

      - name: Install System Build Dependencies (with XDP Resolution)
        run: |
          set -eux
          sudo apt-get update
          # Try to add XDP PPA (may fail if not available for 22.04)
          sudo apt-get install -y software-properties-common || true
          sudo add-apt-repository ppa:xdp-project/xdp --yes || echo "XDP PPA add failed or unavailable - will fallback if needed"
          sudo apt-get update
          # Attempt to install from PPA, allow fallback
          sudo apt-get install -y libxdp1 libxdp-dev || echo "libxdp not in apt repos, fallback required"
          # Check if libxdp got installed
          if ! dpkg -s libxdp1 >/dev/null 2>&1; then
            echo "libxdp1 not found in system repos, BUILDING libxdp from SOURCE..."
            sudo apt-get install -y git build-essential libelf-dev pkg-config libbpf-dev
            git clone --depth 1 https://github.com/xdp-project/libxdp.git /tmp/libxdp
            cd /tmp/libxdp
            make
            sudo make install
            sudo ldconfig  # Update shared library cache
            cd -
            rm -rf /tmp/libxdp
            echo "libxdp built and installed from source."
          fi
          # Install all remaining dependencies (libxdp1/libxdp-dev omitted for source-paths)
          sudo apt-get install -y \
            build-essential python3 python3-venv python3-pip \
            fakeroot devscripts dpkg-dev \
            libffi-dev libmagic1 \
            zip unzip curl wget git lsb-release ca-certificates \
            pkg-config libssl-dev gcc g++ make \
            docker.io
          pip3 install --upgrade pip wheel

      - name: Prepare Output Staging Directory
        run: |
          rm -rf $L_E_OUTDIR
          mkdir -p $L_E_OUTDIR/opt/lucid-empire
          mkdir -p $L_E_OUTDIR/DEBIAN

      - name: Setup Python Venv & Install Python Dependencies
        run: |
          python3 -m venv $L_E_OUTDIR/opt/lucid-empire/venv
          $L_E_OUTDIR/opt/lucid-empire/venv/bin/pip install --upgrade pip
          if [ -f requirements.txt ]; then
            $L_E_OUTDIR/opt/lucid-empire/venv/bin/pip install -r requirements.txt
          fi

      - name: Build C++/Kernel/XDP/Native Patches (if present)
        run: |
          # Recursively build all Makefiles (C++, kernel, juggler, XDP etc)
          find . -type f -name 'Makefile' | while read mk; do
            echo "Building: $mk"
            (cd "$(dirname "$mk")" && make)
          done
          # Copy built .so, .out, .ko, or patched artifacts to the bundle
          find . -type f \( -name "*.so" -o -name "*.out" -o -name "*.ko" \) | while read f; do
            # Copy preserving directory tree
            dest_dir="$L_E_OUTDIR/opt/lucid-empire/$(dirname "$f")"
            mkdir -p "$dest_dir"
            cp "$f" "$dest_dir/"
          done

      - name: Stage Application Source + Assets
        run: |
          rsync -av --exclude ".git" --exclude "__pycache__" --exclude "*.pyc" \
            ./ $L_E_OUTDIR/opt/lucid-empire/

      - name: Stage Patched/Payload Browser (if present)
        run: |
          # Copy patched browser (Firefox or Chromium) if built/patched; fallback to obj-*/dist/bin/firefox
          for loc in bin/firefox/firefox obj-*/dist/bin/firefox; do
            if [ -f "$loc" ]; then
              mkdir -p $L_E_OUTDIR/opt/lucid-empire/browser/
              cp -R "$(dirname $loc)" $L_E_OUTDIR/opt/lucid-empire/browser/
            fi
          done

      - name: Add Systemd Persistence & Post-install Hooks
        run: |
          cat > $L_E_OUTDIR/opt/lucid-empire/lucid-empire.service <<EOF
[Unit]
Description=Lucid Empire C2 (Offensive Anti-Detect Suite)
After=network.target

[Service]
Type=simple
ExecStart=/opt/lucid-empire/venv/bin/python3 /opt/lucid-empire/D3MON_CORE.py
WorkingDirectory=/opt/lucid-empire
Restart=always

[Install]
WantedBy=multi-user.target
EOF
          chmod 644 $L_E_OUTDIR/opt/lucid-empire/lucid-empire.service

      - name: Write DEBIAN/control and postinst Scripts
        run: |
          cat > $L_E_OUTDIR/DEBIAN/control <<EOF
Package: lucid-empire
Version: 5.0.9999
Section: admin
Priority: optional
Architecture: all
Maintainer: Dva.12 <dev@xai.com>
Description: Lucid Empire v5 â€” Offensive Tier 1 Anti-Detect Suite (MAX_AGENCY, OBLIVION READY)
 Bridges Python, C++, XDP, and patched browser anti-detect. For OPERATOR use only. 
Depends: python3, python3-venv, python3-pip, libffi-dev, libmagic1
EOF

          # Post-install hook: enable systemd service
          cat > $L_E_OUTDIR/DEBIAN/postinst <<'EOF2'
#!/bin/bash
set -e
systemctl enable /opt/lucid-empire/lucid-empire.service || true
systemctl start lucid-empire.service || true
echo "Lucid Empire C2 now installed and systemd service started."
EOF2
          chmod 755 $L_E_OUTDIR/DEBIAN/postinst

      - name: Build .deb Package (fakeroot; preserve ownership)
        run: |
          fakeroot dpkg-deb --build $L_E_OUTDIR lucid-empire_v5_oblivion_all.deb

      - name: Upload .deb Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lucid-empire_v5_oblivion_all.deb
          path: lucid-empire_v5_oblivion_all.deb

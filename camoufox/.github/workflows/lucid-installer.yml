name: Lucid Empire Release Builder

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # JOB 1: COMPILE THE BROWSER (WINDOWS TARGET)
  build-browser:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install MozillaBuild
        run: choco install mozillabuild
        
      - name: Bootstrap Build
        run: ./mach bootstrap --application-choice browser --no-interactive
        
      - name: Inject Silence
        run: |
          echo "ac_add_options --disable-telemetry" >> .mozconfig
          echo "ac_add_options --disable-crashreporter" >> .mozconfig
          echo "ac_add_options --target=x86_64-pc-windows-msvc" >> .mozconfig
           
      - name: Compile Warhead
        run: |
         ./mach build
         ./mach package
          
      - name: Upload Binary Artifact
        uses: actions/upload-artifact@v3
        with:
          name: lucid-browser-bin
          path: obj-x86_64-pc-windows-msvc/dist/install/sea/*.zip

  # JOB 2: PACKAGE THE LINUX INSTALLER
  package-installer:
    needs: build-browser
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Download Browser Binary
        uses: actions/download-artifact@v3
        with:
          name: lucid-browser-bin
          path: build_assets/
      
      # Correcting the packaging step to handle root-level source files
      - name: Create Distribution Package
        run: |
          mkdir -p "release/lucid empire"
          
          # Copy everything from root to release/lucid empire, excluding the release dir itself and .git
          rsync -av --exclude='release' --exclude='.git' . "release/lucid empire/"
          
          # Move the installer script to the root of the release folder (outside the empire folder)
          mv "release/lucid empire/install_lucid.sh" release/
          
          # Zip it all
          cd release
          zip -r lucid-empire-installer-v5.zip .
          
      - name: Upload Installer
        uses: actions/upload-artifact@v3
        with:
          name: Lucid-Empire-Installer-Linux
          path: release/lucid-empire-installer-v5.zip

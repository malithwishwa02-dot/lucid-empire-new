name: build-deb

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install build deps
        run: |
          sudo apt update
          sudo apt install -y rsync dpkg-dev fakeroot python3-venv python3-pip
      - name: Lint (flake8)
        run: |
          python -m pip install --upgrade pip
          pip install flake8
          flake8 camoufox || true
      - name: Security scan (bandit)
        run: |
          pip install bandit
          bandit -r camoufox -q || true
      - name: Build .deb
        env:
          VERSION: ${{ github.sha }}
        run: |
          echo "Building using VERSION=${VERSION}"
          ./camoufox/scripts/package_deb.sh "${VERSION}"
      - name: Verify package
        run: |
          set -e
          ls -lah dist || true
          debs=(dist/*.deb)
          if [ ! -f "${debs[0]}" ]; then echo "No .deb produced" >&2; exit 1; fi
          dpkg-deb -c "${debs[0]}"
          dpkg-deb -I "${debs[0]}" || true
      - name: Install & smoke test
        run: |
          set -e
          sudo dpkg -i dist/*.deb || sudo apt-get -f install -y
          if [ -x /usr/bin/lucid-empire ]; then
            /usr/bin/lucid-empire --help || true
          else
            echo "[ERROR] /usr/bin/lucid-empire missing after install" >&2
            exit 1
          fi
          if [ ! -f /opt/lucid-empire/lucid_launcher.py ]; then
            echo "[WARN] /opt/lucid-empire/lucid_launcher.py not present; verify your includes" >&2
          fi
      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: lucid-deb
          path: dist/*.deb

name: CI Monitor

on:
  schedule:
    - cron: '*/15 * * * *' # every 15 minutes
  workflow_dispatch:

permissions:
  actions: write
  issues: write
  pull-requests: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Rerun failing build-linux runs and notify PRs
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const workflow_id = 'build-linux.yml';

            // Fetch recent workflow runs for the build-linux workflow
            const runsResp = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              workflow_id,
              per_page: 50,
            });

            const runs = runsResp.data.workflow_runs || [];
            const now = new Date();

            for (const run of runs) {
              try {
                // Only care about fix/* branches and reasonably recent runs
                if (!run.head_branch || !run.head_branch.startsWith('fix/')) continue;
                const updatedAt = new Date(run.updated_at);
                const hoursSinceUpdate = (now - updatedAt) / (1000 * 60 * 60);
                if (hoursSinceUpdate > 48) continue; // ignore old runs

                // Only rerun completed failed/cancelled runs
                if (run.status === 'in_progress' || run.status === 'queued') continue;
                if (run.conclusion === 'success') continue;

                // Trigger a rerun of this run
                await github.rest.actions.reRunWorkflow({ owner, repo, run_id: run.id });

                // Try to find an open PR for this branch
                const head = `${owner}:${run.head_branch}`;
                const prsResp = await github.rest.pulls.list({ owner, repo, head, state: 'open' });
                const prs = prsResp.data || [];

                const message = `ðŸš¨ **CI Monitor:** Automatically re-ran failing workflow run for branch **${run.head_branch}**\n\n- Run: ${run.html_url}\n- Previous conclusion: ${run.conclusion}\n\nThis run was re-triggered automatically by the CI monitor. If failures persist, please investigate and push a fix.`;

                if (prs.length > 0) {
                  // Comment on the first matching PR
                  const prNum = prs[0].number;
                  await github.rest.issues.createComment({ owner, repo, issue_number: prNum, body: message });
                } else {
                  // Open a new issue to track the failing branch
                  const title = `CI Monitor: failing build for ${run.head_branch}`;
                  await github.rest.issues.create({ owner, repo, title, body: message });
                }

              } catch (err) {
                core.warning(`Failed processing run ${run.id}: ${err}`);
              }
            }
